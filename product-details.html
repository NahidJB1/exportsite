<script type="module">
        import { db, auth } from './firebase-config.js';
        import { 
            doc, 
            getDoc, 
            collection, 
            addDoc, 
            query, 
            where, 
            getDocs, 
            orderBy, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if(!productId) window.location.href = "products.html";

        // Global State
        let currentProduct = null;
        let currentUserUid = null; // Store UID
        let qty = 1;
        let maxStock = 10;
        let unitPrice = 0;

        // --- 1. AUTH LISTENER (CRITICAL FIX) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserUid = user.uid;
                // Now that we have the User ID, we can check if it's already a favorite
                if(currentProduct) checkFavState(); 
            } else {
                // Optional: Redirect if you want to force login to view details
                // window.location.href = "login.html";
            }
        });

        // --- Helpers ---
        function getNumericPrice(priceVal) {
            if (typeof priceVal === 'number') return priceVal;
            return parseFloat(priceVal.replace(/[^0-9.]/g, '')) || 0;
        }

        function formatCurrency(amount) {
            return "RM " + amount.toLocaleString('en-MY', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        async function loadProduct() {
            const docRef = doc(db, "products", productId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                currentProduct = docSnap.data();
                renderPage(currentProduct);
                
                // If auth loaded before product, check state now
                if(currentUserUid) checkFavState();
                
                checkReviewEligibility();
                loadReviews();
            } else {
                document.getElementById('productContainer').innerHTML = "<p>Product not found.</p>";
            }
        }

        function renderPage(product) {
            const images = product.images || [product.image];
            const mainImgSrc = images[0];
            
            unitPrice = getNumericPrice(product.sellingPrice || product.price);
            
            if (product.quantity !== undefined) {
                maxStock = product.quantity;
            } else {
                maxStock = (product.status === 'Sold Out') ? 0 : 10;
            }

            const isSoldOut = maxStock === 0;

            const thumbsHtml = images.map((img, index) => 
                `<img src="${img}" class="thumb ${index===0?'active':''}" onclick="changeImage('${img}', this)">`
            ).join('');

            const descriptionText = product.description 
                ? product.description.replace(/\n/g, '<br>') 
                : "No description available.";

            const guaranteeText = product.guarantee || "100% Authentic Product | 7 Days Return Policy";

            document.getElementById('productContainer').innerHTML = `
                <div class="gallery-section">
                    <div class="main-img-box">
                        <img src="${mainImgSrc}" class="main-img" id="mainImage">
                        ${isSoldOut ? '<div style="position:absolute; top:10px; right:10px; background:red; color:white; padding:5px 10px; border-radius:5px; font-weight:bold;">SOLD OUT</div>' : ''}
                    </div>
                    <div class="thumb-grid">${thumbsHtml}</div>
                </div>
                
                <div class="details-section">
                    <span class="cat-badge">${product.category || 'General'}</span>
                    <h1>${product.name}</h1>
                    <div class="price">Unit Price: ${formatCurrency(unitPrice)}</div>
                    
                    <div class="guarantee-box">
                        <i class="fas fa-shield-alt" style="font-size:18px;"></i>
                        <div>
                            <strong style="display:block; margin-bottom:2px;">Shopping Guarantee</strong>
                            <span>${guaranteeText}</span>
                        </div>
                    </div>

                    <div class="qty-wrapper" style="opacity: ${isSoldOut ? '0.5' : '1'}; pointer-events: ${isSoldOut ? 'none' : 'auto'};">
                        <span style="font-weight:600; margin-right:10px;">Quantity:</span>
                        <div class="qty-box">
                            <button class="qty-btn" onclick="updateQty(-1)">-</button>
                            <input type="text" id="qtyInput" value="1" readonly>
                            <button class="qty-btn" onclick="updateQty(1)">+</button>
                        </div>
                    </div>

                    <div class="total-box">
                        <span style="color:#065f46; font-weight:600;">Total Amount:</span>
                        <span id="totalPrice" style="font-size:22px; font-weight:700; color:#059669;">
                            ${formatCurrency(unitPrice)}
                        </span>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-outline" onclick="addToCart()" ${isSoldOut ? 'disabled style="border-color:#ccc; color:#ccc;"' : ''}>
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                        <button class="btn-outline" id="favBtn" onclick="toggleDetailsFav()">
                            <i class="far fa-heart"></i> Favorite
                        </button>
                    </div>

                    <button class="btn-buy" onclick="goToCheckout()" ${isSoldOut ? 'disabled style="background:#ccc; cursor:not-allowed;"' : ''}>
                        ${isSoldOut ? 'Currently Unavailable' : 'Proceed to Checkout <i class="fas fa-arrow-right"></i>'}
                    </button>

                    <div class="desc-container">
                        <h3 style="margin:0 0 10px; color:#333; font-size:16px;">Product Description</h3>
                        <div class="desc-content" id="descContent">
                            <p style="margin:0;">${descriptionText}</p>
                        </div>
                        <button class="read-more-btn" onclick="toggleDescription()" id="readMoreBtn">Read More <i class="fas fa-chevron-down"></i></button>
                    </div>
                </div>

                <div class="reviews-container">
                    <div class="review-header">
                        <h3 class="review-title">Customer Reviews</h3>
                        <div id="reviewBtnContainer"></div> 
                    </div>
                    <div id="reviewForm" class="review-form-box">
                        <h4 style="margin:0 0 10px; color:#003366;">Write a Review</h4>
                        <div class="star-rating-input" id="starInput">
                            <i class="fas fa-star" onclick="setRating(1)" data-val="1"></i>
                            <i class="fas fa-star" onclick="setRating(2)" data-val="2"></i>
                            <i class="fas fa-star" onclick="setRating(3)" data-val="3"></i>
                            <i class="fas fa-star" onclick="setRating(4)" data-val="4"></i>
                            <i class="fas fa-star" onclick="setRating(5)" data-val="5"></i>
                        </div>
                        <input type="text" id="reviewName" placeholder="Your Name (Optional)" class="review-input" style="margin-bottom:10px;">
                        <textarea id="reviewText" rows="3" placeholder="How was the product?" class="review-input"></textarea>
                        <button class="btn-submit-review" onclick="submitReview()">Post Review</button>
                    </div>
                    <div id="reviewsList">
                        <p class="no-reviews"><i class="fas fa-spinner fa-spin"></i> Loading reviews...</p>
                    </div>
                </div>
            `;
        }

        window.changeImage = (src, el) => {
            document.getElementById('mainImage').src = src;
            document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        };

        window.showToast = (msg, type = 'default') => {
            const box = document.getElementById('toast-box');
            const el = document.createElement('div');
            el.className = `toast-msg ${type}`;
            
            let icon = '<i class="fas fa-info-circle"></i>';
            if(type === 'warning') icon = '<i class="fas fa-exclamation-circle"></i>';
            if(type === 'success') icon = '<i class="fas fa-check-circle"></i>';

            el.innerHTML = `${icon} <span>${msg}</span>`;
            box.appendChild(el);

            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(10px)';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        };

        window.updateQty = (change) => {
            const input = document.getElementById('qtyInput');
            let currentVal = parseInt(input.value);
            let newVal = currentVal + change;

            if(newVal < 1) return;

            if(newVal > maxStock) {
                const qtyBox = document.querySelector('.qty-box');
                qtyBox.style.transform = "translateX(5px)";
                setTimeout(() => qtyBox.style.transform = "translateX(0)", 100);
                setTimeout(() => qtyBox.style.transform = "translateX(-5px)", 200);
                setTimeout(() => qtyBox.style.transform = "translateX(0)", 300);
                showToast(`Maximum limit reached. Only ${maxStock} available.`, 'warning');
                return; 
            }

            qty = newVal;
            input.value = qty;
            const total = unitPrice * qty;
            document.getElementById('totalPrice').innerText = formatCurrency(total);
        };

        window.goToCheckout = () => {
            const finalTotal = unitPrice * qty;
            const params = new URLSearchParams({
                id: productId,
                name: currentProduct.name,
                unitPrice: unitPrice,
                totalPrice: finalTotal, 
                img: currentProduct.images ? currentProduct.images[0] : (currentProduct.image || ''),
                qty: qty
            });
            window.location.href = `checkout.html?${params.toString()}`;
        };

        // --- CART LOGIC (User Specific Fix) ---
        window.addToCart = () => {
            if(!currentUserUid) {
                showToast("Please login first", "warning");
                setTimeout(() => window.location.href="login.html", 1500);
                return;
            }

            // Key Change: Use UID in storage key
            const storageKey = `cart_${currentUserUid}`;
            let cart = JSON.parse(localStorage.getItem(storageKey)) || [];
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if ((existingItem.qty + qty) > maxStock) {
                    showToast(`You already have ${existingItem.qty} in your cart. Limit reached.`, 'warning');
                    return;
                }
                existingItem.qty += qty;
            } else {
                cart.push({
                    id: productId,
                    name: currentProduct.name,
                    price: formatCurrency(unitPrice), 
                    image: currentProduct.images ? currentProduct.images[0] : (currentProduct.image || ''),
                    qty: qty
                });
            }
            localStorage.setItem(storageKey, JSON.stringify(cart));

            showToast("Added to your cart!", 'success');

            const btn = document.querySelector('.btn-outline');
            if(btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = `<i class="fas fa-check"></i> Added!`;
                btn.style.background = "#dcfce7"; 
                btn.style.borderColor = "#22c55e";
                btn.style.color = "#15803d";
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = "white";
                    btn.style.borderColor = "#003366";
                    btn.style.color = "#003366";
                }, 2000);
            }
        };

        // --- FAVORITE LOGIC (User Specific Fix) ---
        window.toggleDetailsFav = () => {
            if(!currentUserUid) {
                showToast("Please login first", "warning");
                return;
            }

            // Key Change: Use UID in storage key
            const storageKey = `favorites_${currentUserUid}`;
            let favs = JSON.parse(localStorage.getItem(storageKey)) || [];
            
            const index = favs.indexOf(productId);
            const btn = document.getElementById('favBtn');
            const icon = btn.querySelector('i');

            if (index === -1) {
                favs.push(productId);
                btn.classList.add('active-fav');
                icon.classList.remove('far');
                icon.classList.add('fas');
            } else {
                favs.splice(index, 1);
                btn.classList.remove('active-fav');
                icon.classList.add('far');
                icon.classList.remove('fas');
            }
            localStorage.setItem(storageKey, JSON.stringify(favs));
        };
        
        function checkFavState() {
            if(!currentUserUid) return;
            const storageKey = `favorites_${currentUserUid}`;
            const favs = JSON.parse(localStorage.getItem(storageKey)) || [];
            
            if(favs.includes(productId)) {
                const btn = document.getElementById('favBtn');
                if(btn) {
                    btn.classList.add('active-fav');
                    const icon = btn.querySelector('i');
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                }
            }
        }

        // --- REVIEW SYSTEM ---
        let selectedRating = 0;

        async function loadReviews() {
            const list = document.getElementById('reviewsList');
            const reviewsRef = collection(db, "reviews");
            const q = query(reviewsRef, where("productId", "==", productId), orderBy("createdAt", "desc"));

            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    list.innerHTML = `<p class="no-reviews">No reviews yet. Be the first to review!</p>`;
                    return;
                }
                let html = '';
                querySnapshot.forEach((doc) => {
                    const r = doc.data();
                    const date = r.createdAt ? r.createdAt.toDate().toLocaleDateString() : 'Just now';
                    html += `
                        <div class="review-card">
                            <div class="review-user">
                                <span>${r.userName}</span>
                                <span class="review-date">${date}</span>
                            </div>
                            <div class="review-stars">${getStarHtml(r.rating)}</div>
                            <div class="review-text">${r.comment}</div>
                        </div>
                    `;
                });
                list.innerHTML = html;
            } catch (error) {
                list.innerHTML = `<p class="no-reviews">Could not load reviews.</p>`;
            }
        }

        function getStarHtml(rating) {
            let stars = '';
            for(let i=1; i<=5; i++) {
                if(i <= rating) stars += '<i class="fas fa-star"></i>';
                else stars += '<i class="far fa-star"></i>';
            }
            return stars;
        }

        function checkReviewEligibility() {
            // Using generic logic for now, could be updated to user specific if needed later
            const deliveredOrders = JSON.parse(localStorage.getItem('delivered_orders')) || [];
            const isEligible = true; 
            if(isEligible) {
                document.getElementById('reviewBtnContainer').innerHTML = 
                    `<button class="btn-outline" style="padding:5px 15px; font-size:14px;" onclick="document.getElementById('reviewForm').style.display='block'">
                        Write a Review
                    </button>`;
            }
        }

        window.setRating = (val) => {
            selectedRating = val;
            updateStarInputUI();
        };

        function updateStarInputUI() {
            const stars = document.querySelectorAll('#starInput i');
            stars.forEach(star => {
                const starVal = parseInt(star.getAttribute('data-val'));
                if(starVal <= selectedRating) {
                    star.classList.add('active');
                    star.style.color = "#f59e0b";
                } else {
                    star.classList.remove('active');
                    star.style.color = "#ddd";
                }
            });
        }

        window.submitReview = async () => {
            const comment = document.getElementById('reviewText').value;
            const name = document.getElementById('reviewName').value || "Anonymous Customer";

            if(selectedRating === 0) {
                showToast("Please select a star rating", "warning");
                return;
            }

            const btn = document.querySelector('.btn-submit-review');
            btn.innerHTML = "Posting...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, "reviews"), {
                    productId: productId,
                    rating: selectedRating,
                    comment: comment,
                    userName: name,
                    createdAt: serverTimestamp()
                });
                document.getElementById('reviewForm').style.display = 'none';
                document.getElementById('reviewText').value = '';
                selectedRating = 0;
                updateStarInputUI();
                loadReviews();
                showToast("Review submitted successfully!", "success");
            } catch (e) {
                console.error(e);
                showToast("Error submitting review.", "warning");
            } finally {
                btn.innerHTML = "Post Review";
                btn.disabled = false;
            }
        };

        window.toggleDescription = () => {
            const content = document.getElementById('descContent');
            const btn = document.getElementById('readMoreBtn');
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.innerHTML = 'Read More <i class="fas fa-chevron-down"></i>';
            } else {
                content.classList.add('expanded');
                btn.innerHTML = 'Show Less <i class="fas fa-chevron-up"></i>';
            }
        };

        loadProduct();
    </script>
