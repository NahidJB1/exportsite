<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details | Nusantara Trade</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; display: flex; flex-wrap: wrap; gap: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        
        /* Gallery Styles */
        .gallery-section { flex: 1; min-width: 300px; }
        .main-img-box { width: 100%; height: 350px; background: #eee; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        .main-img { width: 100%; height: 100%; object-fit: contain; transition: 0.3s; }
        .thumb-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .thumb { width: 70px; height: 70px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; object-fit: cover; background: #f9f9f9; }
        .thumb.active { border-color: #003366; }

        /* Details Styles */
        .details-section { flex: 1; min-width: 300px; }
        .cat-badge { background: #e0f2fe; color: #003366; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        h1 { margin: 15px 0; color: #003366; font-size: 28px; }
        .price { font-size: 24px; color: #00A86B; font-weight: 700; margin-bottom: 25px; }
        
        /* Quantity Selector */
        .qty-wrapper { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        .qty-box { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .qty-btn { background: #f8fafc; border: none; padding: 10px 15px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .qty-btn:hover { background: #e2e8f0; }
        #qtyInput { width: 50px; text-align: center; border: none; font-weight: 600; font-family: inherit; outline: none; }

        .btn-buy { background: #003366; color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; }
        .btn-buy:hover { background: #002244; transform: translateY(-2px); }
        .back-link { display: inline-block; margin-bottom: 20px; color: #666; text-decoration: none; }
    </style>
</head>
<body>

    <a href="products.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Shop</a>

    <div class="container" id="productContainer">
        <div style="width:100%; text-align:center; padding:50px;">
            <i class="fas fa-spinner fa-spin fa-2x"></i> Loading Product...
        </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if(!productId) window.location.href = "products.html";

        let currentProduct = null;
        let qty = 1;

        async function loadProduct() {
            const docRef = doc(db, "products", productId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                currentProduct = docSnap.data();
                renderPage(currentProduct);
            } else {
                document.getElementById('productContainer').innerHTML = "<p>Product not found.</p>";
            }
        }

        function renderPage(product) {
    const images = product.images || [product.image];
    
    // Create the thumbnails HTML
    const thumbsHtml = images.map((img, index) => 
        `<img src="${img}" class="thumb ${index===0?'active':''}" onclick="changeImage('${img}', this)">`
    ).join('');

    const descriptionText = product.description 
        ? product.description.replace(/\n/g, '<br>') 
        : "No description available for this product.";

    // Main Image
    const mainImgSrc = images[0];

    document.getElementById('productContainer').innerHTML = `
        <div class="gallery-section">
            <div class="main-img-box">
                <img src="${mainImgSrc}" class="main-img" id="mainImage">
            </div>
            <div class="thumb-grid">
                ${thumbsHtml} </div>
        </div>
        
        <div class="details-section">
            <span class="cat-badge">${product.category}</span>
            <h1>${product.name}</h1>
            <div class="price">${product.price}</div>
            
            <div style="margin-bottom: 25px; color: #555; line-height: 1.6; border-top: 1px solid #eee; padding-top: 20px;">
                <h3 style="margin:0 0 10px; color:#333; font-size:16px;">Description</h3>
                <p style="margin:0; font-size:14px;">${descriptionText}</p>
            </div>

            <div class="qty-wrapper">
                <span style="font-weight:600; margin-right:10px;">Quantity:</span>
                <div class="qty-box">
                    <button class="qty-btn" onclick="updateQty(-1)">-</button>
                    <input type="text" id="qtyInput" value="1" readonly>
                    <button class="qty-btn" onclick="updateQty(1)">+</button>
                </div>
            </div>

            <button class="btn-buy" onclick="goToCheckout()">
                Proceed to Checkout <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    `;
}

        // Make functions global for HTML onclick access
        window.changeImage = (src, el) => {
            document.getElementById('mainImage').src = src;
            document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        };

        window.updateQty = (change) => {
            const input = document.getElementById('qtyInput');
            let val = parseInt(input.value);
            val += change;
            if(val < 1) val = 1;
            if(val > 10) val = 10; // Max limit
            input.value = val;
            qty = val;
        };

        window.goToCheckout = () => {
            // Pass ID and Quantity to checkout page
            // We re-encode product data to avoid extra DB calls on checkout if possible, 
            // but passing ID + Qty is safer. Let's pass basic data.
            const params = new URLSearchParams({
                id: productId,
                name: currentProduct.name,
                price: currentProduct.price,
                img: currentProduct.images ? currentProduct.images[0] : currentProduct.image,
                qty: qty
            });
            window.location.href = `checkout.html?${params.toString()}`;
        };

        loadProduct();
    </script>
</body>
</html>
