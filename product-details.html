<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details | Nusantara Trade</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; display: flex; flex-wrap: wrap; gap: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        
        .gallery-section { flex: 1; min-width: 300px; }
        .main-img-box { width: 100%; height: 350px; background: #eee; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        .main-img { width: 100%; height: 100%; object-fit: contain; }
        .thumb-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .thumb { width: 70px; height: 70px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; object-fit: cover; background: #f9f9f9; }
        .thumb.active { border-color: #003366; }

        .details-section { flex: 1; min-width: 300px; }
        .cat-badge { background: #e0f2fe; color: #003366; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        h1 { margin: 15px 0; color: #003366; font-size: 28px; }
        .price { font-size: 24px; color: #00A86B; font-weight: 700; margin-bottom: 25px; }
        
        .qty-wrapper { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .qty-box { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .qty-btn { background: #f8fafc; border: none; padding: 10px 15px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .qty-btn:hover { background: #e2e8f0; }
        #qtyInput { width: 50px; text-align: center; border: none; font-weight: 600; font-family: inherit; outline: none; }

        /* NEW: Total Price Box Style */
        .total-box {
            background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; 
            border-radius: 8px; margin-bottom: 25px; 
            display: flex; justify-content: space-between; align-items: center;
        }

        .btn-buy { background: #003366; color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; }
        .btn-buy:hover { background: #002244; transform: translateY(-2px); }
        .back-link { display: inline-block; margin-bottom: 20px; color: #666; text-decoration: none; }

        /* ACTION BUTTONS GRID */
        .action-buttons {
            display: flex; gap: 10px; margin-bottom: 15px;
        }
        .btn-outline {
            flex: 1; padding: 12px; border-radius: 10px;
            border: 2px solid #003366; background: white;
            color: #003366; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }
        .btn-outline:hover { background: #f0f9ff; }
        .btn-outline.active-fav { background: #fee2e2; border-color: #ef4444; color: #ef4444; }

        /* REVIEW SECTION STYLES */
        .reviews-container {
            width: 100%; margin-top: 40px; border-top: 2px solid #eee; padding-top: 30px;
        }
        .review-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .review-title { font-size: 22px; font-weight: 700; color: #003366; margin: 0; }
        
        /* Write Review Form */
        .review-form-box {
            background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 30px;
            display: none; /* Hidden by default, shown if eligible */
        }
        .star-rating-input { display: flex; gap: 10px; margin-bottom: 15px; }
        .star-rating-input i { font-size: 24px; color: #ddd; cursor: pointer; transition: 0.2s; }
        .star-rating-input i.active { color: #f59e0b; }
        
        .review-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-family: inherit; margin-bottom: 15px; resize: vertical; }
        .btn-submit-review { background: #003366; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-submit-review:hover { background: #002244; }

        /* Review List */
        .review-card { background: white; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .review-user { font-weight: 700; color: #333; display: flex; justify-content: space-between; }
        .review-date { font-size: 12px; color: #888; font-weight: 400; }
        .review-stars { color: #f59e0b; font-size: 14px; margin: 5px 0 8px; }
        .review-text { font-size: 14px; color: #555; line-height: 1.5; }
        .no-reviews { color: #666; font-style: italic; }

        @media (max-width: 600px) {
            .review-header { flex-direction: column; align-items: flex-start; gap: 10px; }
        }

        /* --- NEW STYLES FOR UPDATES --- */
.guarantee-box {
    background: #fffbeb; 
    border: 1px solid #fcd34d; 
    color: #92400e; 
    padding: 12px 15px; 
    border-radius: 8px; 
    font-size: 14px; 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    margin-bottom: 25px; /* Takes the place of description */
}

/* Description Toggle Styles */
.desc-container {
    margin-top: 25px; 
    border-top: 1px solid #eee; 
    padding-top: 20px;
}
.desc-content {
    font-size: 14px; 
    color: #555; 
    line-height: 1.6;
    max-height: 80px; /* Short limit initially */
    overflow: hidden;
    position: relative;
    transition: max-height 0.5s ease;
}
.desc-content.expanded {
    max-height: 1000px; /* Large enough to show full text */
}
.desc-content::after {
    content: "";
    position: absolute; bottom: 0; left: 0; width: 100%; height: 40px;
    background: linear-gradient(transparent, white);
    pointer-events: none;
}
.desc-content.expanded::after { display: none; }

.read-more-btn {
    background: none; border: none; color: #003366; 
    font-weight: 600; font-size: 13px; cursor: pointer; 
    padding: 5px 0; margin-top: 5px;
}
.read-more-btn:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <a href="products.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Shop</a>

    <div class="container" id="productContainer">
        <div style="width:100%; text-align:center; padding:50px;">
            <i class="fas fa-spinner fa-spin fa-2x"></i> Loading Product...
        </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
    import { 
        doc, 
        getDoc, 
        collection, 
        addDoc, 
        query, 
        where, 
        getDocs, 
        orderBy, 
        serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if(!productId) window.location.href = "products.html";

        let currentProduct = null;
        let qty = 1;

        // --- 1. Helper: Get Number from "BDT 45,000" ---
        function parsePrice(priceStr) {
            if(!priceStr) return 0;
            // Remove everything except numbers and dots
            return parseFloat(priceStr.replace(/[^0-9.]/g, '')) || 0;
        }

        // --- 2. Helper: Get Currency Name like "BDT" or "$" ---
        function getCurrency(priceStr) {
            if(!priceStr) return '';
            // Remove numbers, commas and dots to find text
            return priceStr.replace(/[0-9.,]/g, '').trim();
        }

        async function loadProduct() {
    const docRef = doc(db, "products", productId);
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
        currentProduct = docSnap.data();
        renderPage(currentProduct);
        checkFavState(); // <--- This line was commented out in your file
        checkReviewEligibility();
        loadReviews();
    } else {
        document.getElementById('productContainer').innerHTML = "<p>Product not found.</p>";
    }
}

        function renderPage(product) {
    const images = product.images || [product.image];
    const thumbsHtml = images.map((img, index) => 
        `<img src="${img}" class="thumb ${index===0?'active':''}" onclick="changeImage('${img}', this)">`
    ).join('');

    const descriptionText = product.description 
        ? product.description.replace(/\n/g, '<br>') 
        : "No description available.";

    // Default guarantee text if none provided in dashboard
    const guaranteeText = product.guarantee || "100% Authentic Product | 7 Days Return Policy";

    const mainImgSrc = images[0];

    document.getElementById('productContainer').innerHTML = `
        <div class="gallery-section">
            <div class="main-img-box">
                <img src="${mainImgSrc}" class="main-img" id="mainImage">
            </div>
            <div class="thumb-grid">
                ${thumbsHtml} 
            </div>
        </div>
        
        <div class="details-section">
            <span class="cat-badge">${product.category}</span>
            <h1>${product.name}</h1>
            <div class="price">Unit Price: ${product.price}</div>
            
            <div class="guarantee-box">
                <i class="fas fa-shield-alt" style="font-size:18px;"></i>
                <div>
                    <strong style="display:block; margin-bottom:2px;">Shopping Guarantee</strong>
                    <span>${guaranteeText}</span>
                </div>
            </div>

            <div class="qty-wrapper">
                <span style="font-weight:600; margin-right:10px;">Quantity:</span>
                <div class="qty-box">
                    <button class="qty-btn" onclick="updateQty(-1)">-</button>
                    <input type="text" id="qtyInput" value="1" readonly>
                    <button class="qty-btn" onclick="updateQty(1)">+</button>
                </div>
            </div>

            <div class="total-box">
                <span style="color:#065f46; font-weight:600;">Total Amount:</span>
                <span id="totalPrice" style="font-size:22px; font-weight:700; color:#059669;">${product.price}</span>
            </div>

            <div class="action-buttons">
                <button class="btn-outline" onclick="addToCart()">
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
                <button class="btn-outline" id="favBtn" onclick="toggleDetailsFav()">
                    <i class="far fa-heart"></i> Favorite
                </button>
            </div>

            <button class="btn-buy" onclick="goToCheckout()">
                Proceed to Checkout <i class="fas fa-arrow-right"></i>
            </button>

            <div class="desc-container">
                <h3 style="margin:0 0 10px; color:#333; font-size:16px;">Product Description</h3>
                <div class="desc-content" id="descContent">
                    <p style="margin:0;">${descriptionText}</p>
                </div>
                <button class="read-more-btn" onclick="toggleDescription()" id="readMoreBtn">Read More <i class="fas fa-chevron-down"></i></button>
            </div>
        </div>

        <div class="reviews-container">
            <div class="review-header">
                <h3 class="review-title">Customer Reviews</h3>
                <div id="reviewBtnContainer"></div> 
            </div>

            <div id="reviewForm" class="review-form-box">
                <h4 style="margin:0 0 10px; color:#003366;">Write a Review</h4>
                <div class="star-rating-input" id="starInput">
                    <i class="fas fa-star" onclick="setRating(1)" data-val="1"></i>
                    <i class="fas fa-star" onclick="setRating(2)" data-val="2"></i>
                    <i class="fas fa-star" onclick="setRating(3)" data-val="3"></i>
                    <i class="fas fa-star" onclick="setRating(4)" data-val="4"></i>
                    <i class="fas fa-star" onclick="setRating(5)" data-val="5"></i>
                </div>
                <input type="text" id="reviewName" placeholder="Your Name (Optional)" class="review-input" style="margin-bottom:10px;">
                <textarea id="reviewText" rows="3" placeholder="How was the product?" class="review-input"></textarea>
                <button class="btn-submit-review" onclick="submitReview()">Post Review</button>
            </div>

            <div id="reviewsList">
                <p class="no-reviews"><i class="fas fa-spinner fa-spin"></i> Loading reviews...</p>
            </div>
        </div>
    `;
}

        window.changeImage = (src, el) => {
            document.getElementById('mainImage').src = src;
            document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        };

        // --- 3. Updated Logic: Calculate Total ---
        window.updateQty = (change) => {
            const input = document.getElementById('qtyInput');
            let val = parseInt(input.value);
            val += change;
            if(val < 1) val = 1;
            if(val > 10) val = 10; 
            input.value = val;
            qty = val;

            // Math Magic
            const unitPrice = parsePrice(currentProduct.price);
            const totalPrice = unitPrice * qty;
            const currency = getCurrency(currentProduct.price);

            // Update the display with commas (e.g., 45,000)
            document.getElementById('totalPrice').innerText = currency + " " + totalPrice.toLocaleString();
        };

        window.goToCheckout = () => {
            const params = new URLSearchParams({
                id: productId,
                name: currentProduct.name,
                price: currentProduct.price,
                img: currentProduct.images ? currentProduct.images[0] : currentProduct.image,
                qty: qty
            });
            window.location.href = `checkout.html?${params.toString()}`;
        };

        loadProduct();

// --- CART LOGIC (No Alert) ---
        window.addToCart = () => {
            let cart = JSON.parse(localStorage.getItem('myCart')) || [];
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.qty += qty;
            } else {
                cart.push({
                    id: productId,
                    name: currentProduct.name,
                    price: currentProduct.price,
                    image: currentProduct.images ? currentProduct.images[0] : currentProduct.image,
                    qty: qty
                });
            }
            localStorage.setItem('myCart', JSON.stringify(cart));

            // Visual Feedback (Instead of Alert)
            const btn = document.querySelector('.btn-outline');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-check"></i> Added!`;
            btn.style.background = "#dcfce7"; 
            btn.style.borderColor = "#22c55e";
            btn.style.color = "#15803d";
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = "white";
                btn.style.borderColor = "#003366";
                btn.style.color = "#003366";
            }, 2000);
        };

        // --- FAVORITE LOGIC (Details Page) ---
        window.toggleDetailsFav = () => {
            let favs = JSON.parse(localStorage.getItem('myFavorites')) || [];
            const index = favs.indexOf(productId);
            const btn = document.getElementById('favBtn');
            const icon = btn.querySelector('i');

            if (index === -1) {
                favs.push(productId);
                btn.classList.add('active-fav');
                icon.classList.remove('far');
                icon.classList.add('fas');
            } else {
                favs.splice(index, 1);
                btn.classList.remove('active-fav');
                icon.classList.add('far');
                icon.classList.remove('fas');
            }
            localStorage.setItem('myFavorites', JSON.stringify(favs));
        };
        
        // Check initial Fav state when page loads
        function checkFavState() {
            const favs = JSON.parse(localStorage.getItem('myFavorites')) || [];
            if(favs.includes(productId)) {
                const btn = document.getElementById('favBtn');
                if(btn) {
                    btn.classList.add('active-fav');
                    btn.querySelector('i').classList.replace('far', 'fas');
                }
            }
        }
        // Add this line inside your loadProduct() function, right after renderPage(currentProduct):
        // checkFavState();

        // --- 4. REVIEW SYSTEM LOGIC ---
        
        let selectedRating = 0;

        // A. Load Reviews from Firestore
        async function loadReviews() {
            const list = document.getElementById('reviewsList');
            const reviewsRef = collection(db, "reviews");
            // Query reviews for THIS product, ordered by newest first
            const q = query(
                reviewsRef, 
                where("productId", "==", productId),
                orderBy("createdAt", "desc") 
            );

            try {
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    list.innerHTML = `<p class="no-reviews">No reviews yet. Be the first to review!</p>`;
                    return;
                }

                let html = '';
                querySnapshot.forEach((doc) => {
                    const r = doc.data();
                    // Convert Timestamp to readable date
                    const date = r.createdAt ? r.createdAt.toDate().toLocaleDateString() : 'Just now';
                    
                    html += `
                        <div class="review-card">
                            <div class="review-user">
                                <span>${r.userName}</span>
                                <span class="review-date">${date}</span>
                            </div>
                            <div class="review-stars">
                                ${getStarHtml(r.rating)}
                            </div>
                            <div class="review-text">${r.comment}</div>
                        </div>
                    `;
                });
                list.innerHTML = html;

            } catch (error) {
                console.error("Error loading reviews:", error);
                // If index error occurs (common in Firestore for composite queries), 
                // fallback to simple text or check console for link to create index.
                list.innerHTML = `<p class="no-reviews">Could not load reviews at this time.</p>`;
            }
        }

        // B. Helper to generate Star Icons
        function getStarHtml(rating) {
            let stars = '';
            for(let i=1; i<=5; i++) {
                if(i <= rating) stars += '<i class="fas fa-star"></i>';
                else stars += '<i class="far fa-star"></i>';
            }
            return stars;
        }

        // C. Check Eligibility & Handle Form
        function checkReviewEligibility() {
            // LOGIC: Check localStorage for "delivered_orders"
            // You must save delivered order IDs here when order status updates to "Delivered"
            const deliveredOrders = JSON.parse(localStorage.getItem('delivered_orders')) || [];
            
            // FOR TESTING: We assume TRUE so you can see the form. 
            // Change "true" to "deliveredOrders.includes(productId)" for production.
            const isEligible = true; 

            if(isEligible) {
                document.getElementById('reviewBtnContainer').innerHTML = 
                    `<button class="btn-outline" style="padding:5px 15px; font-size:14px;" onclick="document.getElementById('reviewForm').style.display='block'">
                        Write a Review
                    </button>`;
            }
        }

        // D. Star Selection Logic (UPDATED)
        window.setRating = (val) => {
            selectedRating = val;
            updateStarInputUI();
        };

        function updateStarInputUI() {
            // Select stars using the ID ensures we get the right specific elements
            const stars = document.querySelectorAll('#starInput i');
            stars.forEach(star => {
                const starVal = parseInt(star.getAttribute('data-val'));
                if(starVal <= selectedRating) {
                    star.classList.add('active');
                    star.style.color = "#f59e0b"; // Force color update
                } else {
                    star.classList.remove('active');
                    star.style.color = "#ddd"; // Force inactive color
                }
            });
        }

        // E. Submit Review to Firestore
        window.submitReview = async () => {
            const comment = document.getElementById('reviewText').value;
            const name = document.getElementById('reviewName').value || "Anonymous Customer";

            if(selectedRating === 0) {
                alert("Please select a star rating.");
                return;
            }

            const btn = document.querySelector('.btn-submit-review');
            btn.innerHTML = "Posting...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, "reviews"), {
                    productId: productId,
                    rating: selectedRating,
                    comment: comment,
                    userName: name,
                    createdAt: serverTimestamp()
                });

                // Reset Form
                document.getElementById('reviewForm').style.display = 'none';
                document.getElementById('reviewText').value = '';
                selectedRating = 0;
                updateStarInputUI();
                
                // Reload Reviews
                loadReviews();
                alert("Thank you for your review!");

            } catch (e) {
                console.error("Error adding review: ", e);
                alert("Error submitting review.");
            } finally {
                btn.innerHTML = "Post Review";
                btn.disabled = false;
            }
        };

        window.toggleDescription = () => {
    const content = document.getElementById('descContent');
    const btn = document.getElementById('readMoreBtn');
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        btn.innerHTML = 'Read More <i class="fas fa-chevron-down"></i>';
    } else {
        content.classList.add('expanded');
        btn.innerHTML = 'Show Less <i class="fas fa-chevron-up"></i>';
    }
};

        // Trigger loading
        // Add this check after renderPage finishes in loadProduct()
        // But for now, we can just call it safely here:
        // (Wait for renderPage to inject HTML before calling these)
    </script>
</body>
</html>
