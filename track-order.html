<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Order | Nusantara Trade</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #003366;       
            --secondary: #00A86B;     
            --bg-light: #F4F7F6;
            --white: #ffffff;
            --status-pending: #FF9900;
            --status-shipped: #003366;
            --status-delivered: #00A86B;
            --status-cancelled: #ff4444;
        }

        body { font-family: 'Poppins', sans-serif; background: var(--bg-light); margin: 0; padding: 0; }

        /* Navbar (Consistent with Products) */
        .navbar {
            background: var(--white); padding: 15px 5%; display: flex; 
            justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .brand { font-size: 20px; font-weight: 700; color: var(--primary); text-decoration: none; }
        .brand span { color: var(--secondary); }
        .nav-link { color: #666; text-decoration: none; font-size: 14px; margin-left: 20px; transition: 0.3s; }
        .nav-link:hover { color: var(--primary); }

        /* Tracking Container */
        .track-container {
            max-width: 600px; margin: 40px auto; padding: 20px;
        }

        .search-card {
            background: white; padding: 30px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center;
        }
        
        .search-box {
            position: relative; margin-top: 20px;
        }
        .search-box input {
            width: 100%; padding: 15px 50px 15px 20px;
            border: 2px solid #eee; border-radius: 30px;
            font-size: 16px; outline: none; box-sizing: border-box; transition: 0.3s;
        }
        .search-box input:focus { border-color: var(--primary); }
        
        .btn-track {
            position: absolute; right: 5px; top: 5px; bottom: 5px;
            background: var(--primary); color: white; border: none;
            padding: 0 25px; border-radius: 25px; cursor: pointer; font-weight: 600;
        }
        .btn-track:hover { background: #002244; }

        /* Results Area */
        .results-area { margin-top: 30px; }
        
        .order-card {
            background: white; border-radius: 10px; padding: 20px;
            margin-bottom: 20px; border-left: 5px solid #ccc;
            box-shadow: 0 3px 10px rgba(0,0,0,0.03);
            animation: fadeIn 0.5s ease;
        }
        
        /* Dynamic Border Colors based on status */
        .order-card.Pending { border-left-color: var(--status-pending); }
        .order-card.Shipped { border-left-color: var(--status-shipped); }
        .order-card.Delivered { border-left-color: var(--status-delivered); }
        .order-card.Cancelled { border-left-color: var(--status-cancelled); }

        .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .order-date { font-size: 12px; color: #888; }
        .order-id { font-size: 12px; color: #aaa; margin-bottom: 5px; }
        
        .product-info { display: flex; gap: 15px; align-items: center; }
        .p-thumb { width: 60px; height: 60px; border-radius: 5px; object-fit: cover; background: #eee; }
        .p-details h4 { margin: 0; color: var(--primary); font-size: 16px; }
        .p-details p { margin: 2px 0 0; color: #666; font-size: 14px; }

        /* Status Badge */
        .status-badge {
            padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
            display: inline-block; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .bg-Pending { background: #fff3cd; color: #856404; }
        .bg-Shipped { background: #d1ecf1; color: #0c5460; }
        .bg-Delivered { background: #d4edda; color: #155724; }
        .bg-Cancelled { background: #f8d7da; color: #721c24; }

        /* Messages */
        .msg-box { padding: 15px; border-radius: 5px; font-size: 14px; display: none; margin-top: 15px; }
        .msg-error { background: #ffe6e6; color: #cc0000; }
        .loader { text-align: center; color: #666; display: none; margin-top: 20px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Responsive */
        @media (max-width: 600px) {
            .navbar { padding: 15px; }
            .track-container { padding: 15px; margin: 20px auto; }
            .search-card { padding: 20px; }
            .btn-track { padding: 0 15px; font-size: 14px; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="products.html" class="brand">Nusantara<span>Trade</span></a>
        <a href="products.html" class="nav-link"><i class="fas fa-arrow-left"></i> Back to Shop</a>
    </nav>

    <div class="track-container">
        <div class="search-card">
            <h2><i class="fas fa-truck-fast"></i> Track Order</h2>
            <p style="color:#666; font-size:14px;">Enter the phone number used during checkout.</p>
            
            <div class="search-box">
                <input type="tel" id="trackPhone" placeholder="e.g. 01712345678">
                <button class="btn-track" onclick="findOrder()">Check</button>
            </div>
            
            <div id="statusMsg" class="msg-box"></div>
        </div>

        <div id="loader" class="loader"><i class="fas fa-spinner fa-spin"></i> Searching...</div>
        <div id="resultsArea" class="results-area"></div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.findOrder = async () => {
            const phone = document.getElementById('trackPhone').value.trim();
            const resultsDiv = document.getElementById('resultsArea');
            const msgDiv = document.getElementById('statusMsg');
            const loader = document.getElementById('loader');

            // Reset UI
            resultsDiv.innerHTML = '';
            msgDiv.style.display = 'none';
            
            if(!phone) {
                showMsg("Please enter a phone number", "error");
                return;
            }

            loader.style.display = 'block';

            try {
                // Query: Find orders where customer.phone matches input
                const q = query(
                    collection(db, "orders"), 
                    where("customer.phone", "==", phone),
                    orderBy("createdAt", "desc") // Requires Index (see note below)
                );

                const snapshot = await getDocs(q);
                loader.style.display = 'none';

                if (snapshot.empty) {
                    showMsg("No orders found for this number.", "error");
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const status = data.status || 'Pending';
                    const date = data.createdAt ? data.createdAt.toDate().toLocaleDateString() : 'Just now';
                    
                    const card = `
                        <div class="order-card ${status}">
                            <div class="order-header">
                                <div>
                                    <div class="order-id">Order ID: #${doc.id.slice(0,6)}...</div>
                                    <div class="order-date"><i class="far fa-clock"></i> ${date}</div>
                                </div>
                                <span class="status-badge bg-${status}">${status}</span>
                            </div>
                            <div class="product-info">
                                <img src="${data.product.image}" class="p-thumb">
                                <div class="p-details">
                                    <h4>${data.product.name}</h4>
                                    <p>${data.product.price}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    resultsDiv.innerHTML += card;
                });

            } catch (error) {
                console.error(error);
                loader.style.display = 'none';
                // If index error, it usually defaults to a standard error. 
                // Fallback for missing index: remove orderBy and sort in JS
                if(error.message.includes("index")) {
                     alert("System Note: An index is building. Please try again in a few minutes.");
                } else {
                    showMsg("Error fetching data. Check internet connection.", "error");
                }
            }
        };

        function showMsg(text, type) {
            const el = document.getElementById('statusMsg');
            el.innerText = text;
            el.className = `msg-box msg-${type}`;
            el.style.display = 'block';
        }
    </script>
</body>
</html>