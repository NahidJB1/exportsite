<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Nusantara Trade</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #0f172a;       /* Deep Navy */
            --accent: #3b82f6;        /* Bright Blue */
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f1f5f9;            /* Slightly darker gray for better contrast */
            --card: #ffffff;
            --border: #e2e8f0;
            --text-main: #334155;
            --text-light: #64748b;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; height: 100vh; margin: 0; color: var(--text-main); overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            z-index: 1000;
            transition: transform 0.3s ease;
            padding: 20px;
        }

        .brand { 
            font-size: 20px; font-weight: 700; margin-bottom: 40px; 
            display: flex; align-items: center; gap: 12px; padding-left: 10px;
        }
        .brand span { color: var(--accent); }
        
        .menu-item {
            padding: 14px 20px; cursor: pointer; border-radius: 10px; margin-bottom: 5px; 
            transition: 0.2s; display: flex; align-items: center; font-weight: 500; color: #94a3b8; font-size: 14px;
        }
        .menu-item:hover { background: rgba(255,255,255,0.08); color: white; }
        .menu-item.active { background: var(--accent); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .menu-item i { margin-right: 12px; width: 20px; text-align: center; font-size: 16px; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 30px;
            overflow-y: auto;
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s ease, width 0.3s ease;
        }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header h2 { margin: 0; font-size: 24px; font-weight: 700; color: var(--primary); }
        .menu-toggle { display: none; font-size: 22px; cursor: pointer; color: var(--text-main); }

        .btn-logout { 
            background: white; border: 1px solid var(--border); color: var(--danger); 
            padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; 
            font-size: 13px; transition: 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .btn-logout:hover { background: #fee2e2; border-color: #fecaca; }

        /* --- SECTIONS --- */
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- HOME: STATS & CHART --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { 
            background: white; padding: 24px; border-radius: 16px; display: flex; align-items: center; gap: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid var(--border); cursor: pointer; transition: 0.2s; 
        }
        .stat-card:hover { transform: translateY(-3px); border-color: var(--accent); }
        .stat-icon { width: 56px; height: 56px; border-radius: 12px; background: #eff6ff; color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .stat-info h4 { margin: 0; font-size: 13px; color: var(--text-light); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-info p { margin: 5px 0 0; font-size: 28px; font-weight: 700; color: var(--primary); }

        .chart-card { background: white; padding: 25px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 30px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-filters { display: flex; gap: 10px; }
        .filter-btn { padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--text-light); transition: 0.2s; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .filter-btn:hover:not(.active) { background: #f8fafc; }

        /* --- PRODUCTS: SUB-TABS --- */
        .sub-tabs { display: flex; gap: 15px; margin-bottom: 20px; }
        .sub-tab-btn { 
            flex: 1; padding: 15px; background: white; border: 1px solid var(--border); border-radius: 12px; 
            text-align: center; font-weight: 600; color: var(--text-light); cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .sub-tab-btn i { font-size: 18px; }
        .sub-tab-btn.active { border-color: var(--accent); background: #eff6ff; color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        
        .product-view { display: none; }
        .product-view.active { display: block; animation: fadeIn 0.3s ease; }

        /* --- ORDERS: ACCORDION BARS --- */
        .accordion-container { display: flex; flex-direction: column; gap: 15px; }
        .accordion-item { border: 1px solid var(--border); border-radius: 12px; background: white; overflow: hidden; transition: 0.3s; }
        .accordion-header { 
            padding: 18px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            background: white; font-weight: 600; color: var(--primary);
        }
        .accordion-header:hover { background: #f8fafc; }
        .accordion-header i.arrow { transition: transform 0.3s; color: var(--text-light); }
        .accordion-item.open .accordion-header i.arrow { transform: rotate(180deg); }
        .accordion-item.open .accordion-header { border-bottom: 1px solid var(--border); background: #f8fafc; }
        
        .accordion-content { display: none; padding: 0; }
        .accordion-item.open .accordion-content { display: block; }
        
        .count-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px; }
        .count-badge.pending { background: var(--warning); color: black; }
        .count-badge.success { background: var(--success); }

        /* --- FORMS & GENERAL UI --- */
        .card { background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); border: 1px solid var(--border); margin-bottom: 30px; }
        .card h3 { margin-top: 0; color: var(--primary); font-size: 18px; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 12px; font-weight: 600; color: var(--text-light); margin-bottom: 8px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 14px; background: #fff; transition: 0.2s; color: var(--text-main); }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        /* File Upload */
        .file-upload-wrapper { border: 2px dashed var(--border); border-radius: 10px; padding: 30px; text-align: center; background: #f8fafc; transition: 0.2s; cursor: pointer; position: relative; }
        .file-upload-wrapper:hover { border-color: var(--accent); background: #eff6ff; }
        .btn-submit { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 15px; }
        .btn-submit:hover { background: #1e293b; transform: translateY(-1px); }

        /* --- TABLES --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { text-align: left; color: var(--text-light); font-size: 11px; font-weight: 700; padding: 15px; border-bottom: 2px solid var(--border); text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 16px 15px; border-bottom: 1px solid var(--bg); font-size: 14px; vertical-align: middle; color: var(--text-main); }
        tr:last-child td { border-bottom: none; }
        
        .thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border); }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .status-available { background: #dcfce7; color: #166534; }
        .status-soldout { background: #fee2e2; color: #991b1b; }
        
        .action-btn { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; border: 1px solid transparent; cursor: pointer; transition: 0.2s; }
        .btn-edit { color: var(--accent); background: #eff6ff; border-color: #dbeafe; }
        .btn-delete { color: var(--danger); background: #fef2f2; border-color: #fee2e2; }
        .action-btn:hover { transform: scale(1.05); }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; padding: 30px; border-radius: 16px; width: 95%; max-width: 450px; animation: popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-actions { margin-top: 25px; display: flex; gap: 12px; justify-content: flex-end; }
        .btn-modal { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 14px; }
        .btn-cancel { background: #f1f5f9; color: var(--text-main); }
        .btn-confirm { background: var(--primary); color: white; }

        /* --- TOAST --- */
        #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 16px 20px; border-radius: 10px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 12px; border-left: 4px solid var(--primary); animation: slideIn 0.3s ease; font-weight: 500; min-width: 300px; }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 260px; }
            .sidebar.active { transform: translateX(0); box-shadow: 50px 0 0 100vw rgba(0,0,0,0.5); }
            .main-content { margin-left: 0; width: 100%; padding: 20px; }
            .menu-toggle { display: block; }
            .form-row { grid-template-columns: 1fr; gap: 10px; }
            .sub-tabs { flex-direction: column; gap: 10px; }
            
            thead { display: none; }
            tr { display: block; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 12px; padding: 15px; background: white; }
            td { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--border); }
            td::before { content: attr(data-label); font-weight: 600; color: var(--text-light); font-size: 12px; text-transform: uppercase; }
            .thumb { width: 50px; height: 50px; }
        }

        @media print {
            body * { visibility: hidden; }
            #orderModal, #orderModal * { visibility: visible; }
            #orderModal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; padding-top: 20px; }
            .modal-box { box-shadow: none; border: 2px solid #000; width: 100%; max-width: 100%; }
            .print-btn, .close-icon { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="brand">
            <i class="fas fa-cubes"></i> 
            <div>Nusantara<span>Trade</span></div>
        </div>
        <div class="menu-item active" id="menu-home" onclick="window.switchTab('home')">
            <i class="fas fa-home"></i> Home
        </div>
        <div class="menu-item" id="menu-products" onclick="window.switchTab('products')">
            <i class="fas fa-box-open"></i> Products
        </div>
        <div class="menu-item" id="menu-orders" onclick="window.switchTab('orders')">
            <i class="fas fa-shopping-bag"></i> Orders
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="header-left">
                <i class="fas fa-bars menu-toggle" onclick="window.toggleSidebar()"></i>
                <h2 id="pageTitle">Dashboard</h2>
            </div>
            <button class="btn-logout" onclick="window.logout()">
                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </button>
        </div>

<div id="section-home" class="section active">
    
    <div class="stats-grid">
        <div class="stat-card" onclick="window.switchTab('products')">
            <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
            <div class="stat-info">
                <h4>Total Inventory</h4>
                <p id="stat-inventory">...</p>
            </div>
        </div>
        <div class="stat-card" onclick="window.switchTab('orders'); window.openAccordion('pending')">
            <div class="stat-icon" style="background:#fff7ed; color:#ea580c;"><i class="fas fa-clock"></i></div>
            <div class="stat-info">
                <h4>Pending Orders</h4>
                <p id="stat-pending">...</p>
            </div>
        </div>
        <div class="stat-card" onclick="window.switchTab('orders')">
            <div class="stat-icon" style="background:#ecfdf5; color:#059669;"><i class="fas fa-check-circle"></i></div>
            <div class="stat-info">
                <h4>All Orders</h4>
                <p id="stat-total">...</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background:#f0fdf4; color:#16a34a;"><i class="fas fa-coins"></i></div>
            <div class="stat-info">
                <h4>Est. Total Profit</h4>
                <p id="stat-profit" style="color:#16a34a;">...</p>
            </div>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <h3 style="margin:0; font-size:18px; color:var(--primary)">Sales Overview</h3>
            <div class="chart-filters">
                <button class="filter-btn active" onclick="window.updateChart('sales', 7, this)">7 Days</button>
                <button class="filter-btn" onclick="window.updateChart('sales', 15, this)">15 Days</button>
                <button class="filter-btn" onclick="window.updateChart('sales', 30, this)">30 Days</button>
            </div>
        </div>
        <div style="height: 300px; width: 100%;">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <h3 style="margin:0; font-size:18px; color:var(--primary)">Profit Analytics</h3>
            <div class="chart-filters">
                <button class="filter-btn active" onclick="window.updateChart('profit', 7, this)">7 Days</button>
                <button class="filter-btn" onclick="window.updateChart('profit', 30, this)">1 Month</button>
                <button class="filter-btn" onclick="window.updateChart('profit', 365, this)">1 Year</button>
            </div>
        </div>
        <div style="height: 300px; width: 100%;">
            <canvas id="profitChart"></canvas>
        </div>
    </div>

</div>

        <div id="section-products" class="section">
            <div class="sub-tabs">
                <div class="sub-tab-btn" id="btn-view-add" onclick="window.switchProductView('add')">
                    <i class="fas fa-plus-circle"></i> Add Product
                </div>
                <div class="sub-tab-btn active" id="btn-view-list" onclick="window.switchProductView('list')">
                    <i class="fas fa-list"></i> Product Inventory
                </div>
            </div>

            <div id="view-add" class="product-view card">
                <h3><i class="fas fa-plus"></i> Create New Product</h3>
                <form id="addProductForm">
    <div class="form-row">
        <div>
            <label>Product Name</label>
            <input type="text" id="pName" placeholder="e.g. Wireless Headset" required>
        </div>
        <div>
             <label>Selling Price</label>
             <input type="number" id="pSellPrice" placeholder="e.g. 4500" required>
        </div>
    </div>

    <div class="form-row">
        <div>
            <label>Buying Cost (Admin Only)</label>
            <input type="number" id="pBuyCost" placeholder="e.g. 3500" required>
        </div>
        <div>
            <label>Initial Quantity</label> <input type="number" id="pQty" placeholder="e.g. 50" min="1" required>
        </div>
    </div>

    <div class="form-group">
        <label>Category</label>
        <select id="pCategory">
            <option value="Electronic Accessories">Electronic Accessories</option>
            <option value="Electronic Devices">Electronic Devices</option>
            <option value="Home & Lifestyle">Home & Lifestyle</option>
            <option value="Fashion">Fashion</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>Description</label>
        <textarea id="pDesc" rows="3"></textarea>
    </div>

    <div class="form-group">
        <div class="file-upload-wrapper" style="position: relative;">
            <div class="file-upload-text" id="uploadText">
                <i class="fas fa-cloud-upload-alt"></i><span>Click to upload image</span>
            </div>
            <input type="file" id="pFile" accept="image/*" multiple required onchange="window.updateFileCount(this)" 
                   style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
        </div>
    </div>

    <button type="submit" id="submitBtn" class="btn-submit"><i class="fas fa-save"></i> Save Product</button>
</form>
            </div>

            <div id="view-list" class="product-view active card">
                <h3><i class="fas fa-boxes"></i> Current Stock</h3>
                <table>
                    <thead><tr><th>Img</th><th>Name</th><th>Price</th><th>Stock</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="productTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="section-orders" class="section">
            <h3 style="margin-bottom:20px; color:var(--primary);">Order Management</h3>
            <div class="accordion-container">
                
                <div class="accordion-item" id="acc-pending">
                    <div class="accordion-header" onclick="window.toggleAccordion('pending')">
                        <span><i class="fas fa-clock" style="color:var(--warning); margin-right:10px;"></i> Pending / To Confirm <span class="count-badge pending" id="count-pending">0</span></span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </div>
                    <div class="accordion-content">
                        <table>
                            <thead><tr><th>Date</th><th>Customer</th><th>Items</th><th>Action</th></tr></thead>
                            <tbody id="tbody-pending"></tbody>
                        </table>
                    </div>
                </div>

                <div class="accordion-item" id="acc-confirmed">
                    <div class="accordion-header" onclick="window.toggleAccordion('confirmed')">
                        <span><i class="fas fa-check" style="color:var(--accent); margin-right:10px;"></i> Confirmed (Ready to Ship)</span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </div>
                    <div class="accordion-content">
                        <table>
                            <thead><tr><th>Date</th><th>Customer</th><th>Items</th><th>Action</th></tr></thead>
                            <tbody id="tbody-confirmed"></tbody>
                        </table>
                    </div>
                </div>

                <div class="accordion-item" id="acc-shipped">
                    <div class="accordion-header" onclick="window.toggleAccordion('shipped')">
                        <span><i class="fas fa-shipping-fast" style="color:var(--primary); margin-right:10px;"></i> Shipped</span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </div>
                    <div class="accordion-content">
                        <table>
                            <thead><tr><th>Date</th><th>Customer</th><th>Items</th><th>Action</th></tr></thead>
                            <tbody id="tbody-shipped"></tbody>
                        </table>
                    </div>
                </div>

                <div class="accordion-item" id="acc-delivered">
                    <div class="accordion-header" onclick="window.toggleAccordion('delivered')">
                        <span><i class="fas fa-box-open" style="color:var(--success); margin-right:10px;"></i> Delivered</span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </div>
                    <div class="accordion-content">
                        <table>
                            <thead><tr><th>Date</th><th>Customer</th><th>Items</th><th>Action</th></tr></thead>
                            <tbody id="tbody-delivered"></tbody>
                        </table>
                    </div>
                </div>

                <div class="accordion-item" id="acc-all">
                    <div class="accordion-header" onclick="window.toggleAccordion('all')">
                        <span><i class="fas fa-list" style="color:var(--text-light); margin-right:10px;"></i> All Orders History</span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </div>
                    <div class="accordion-content">
                        <table>
                            <thead><tr><th>Date</th><th>Status</th><th>Customer</th><th>Total</th></tr></thead>
                            <tbody id="tbody-all"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box" style="text-align:center;">
            <i class="fas fa-exclamation-circle" style="font-size:48px; color:var(--warning); margin-bottom:15px;"></i>
            <h3 id="modalTitle" style="margin:0 0 10px 0; color:var(--primary);">Confirmation</h3>
            <p id="modalDesc" style="color:var(--text-light); margin:0;">Are you sure?</p>
            <div class="modal-actions" style="justify-content:center;">
                <button class="btn-modal btn-cancel" onclick="window.closeModal()">Cancel</button>
                <button class="btn-modal btn-confirm" id="modalConfirmBtn">Proceed</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
    <div class="modal-box">
        <h3 style="margin-top:0; border-bottom:1px solid #e2e8f0; padding-bottom:15px;">Edit Product</h3>
        <input type="hidden" id="editId">
        
        <div class="form-row">
            <div><label>Name</label><input type="text" id="editName"></div>
            <div><label>Selling Price</label><input type="number" id="editPrice"></div>
        </div>
        
        <div class="form-row">
            <div><label>Buying Cost</label><input type="number" id="editBuyCost"></div>
            <div><label>Stock Qty</label><input type="number" id="editQty"></div>
        </div>

        <div class="form-group">
            <label>Status</label>
            <select id="editStatus">
                <option value="Available">Available</option>
                <option value="Sold Out">Sold Out</option>
            </select>
        </div>

        <div class="modal-actions">
            <button class="btn-modal btn-cancel" onclick="window.closeEditModal()">Cancel</button>
            <button class="btn-modal btn-confirm" id="saveEditBtn">Save Changes</button>
        </div>
    </div>
</div>

    <div class="modal-overlay" id="orderModal">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #e2e8f0; padding-bottom:10px;">
                <h3 style="margin:0; color:var(--primary);">Invoice / Details</h3>
                <i class="fas fa-times close-icon" onclick="window.closeOrderModal()" style="cursor:pointer; font-size:20px;"></i>
            </div>
            <div id="orderModalContent"></div>
            <button class="btn-submit print-btn" onclick="window.print()" style="margin-top:20px; background:#334155;">
                <i class="fas fa-print"></i> Print Invoice
            </button>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { collection, addDoc, getDocs, getDoc, deleteDoc, updateDoc, doc, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Cloudinary Config (Same as before)
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dounsisel/image/upload";
        const CLOUDINARY_PRESET = "nusantara_upload";

        // Global State
        let targetId = null, targetAction = null, targetValue = null;
        let allOrdersData = []; // Cache for charts
        let chartInstance = null;
        let productCostMap = {}; // Maps ProductID -> BuyingCost
        let profitChartInstance = null;

        // --- GLOBAL HELPERS ---
        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');

        window.switchTab = (tabName) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`section-${tabName}`).classList.add('active');
            document.getElementById(`menu-${tabName}`).classList.add('active');
            
            const titles = { home: 'Dashboard', products: 'Inventory', orders: 'Orders' };
            document.getElementById('pageTitle').innerText = titles[tabName];
            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');
        };

        window.switchProductView = (view) => {
            document.querySelectorAll('.product-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sub-tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${view}`).classList.add('active');
            document.getElementById(`btn-view-${view}`).classList.add('active');
        };

        window.logout = () => signOut(auth).then(() => window.location.href = "login.html");

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "login.html"; 
            else {
                loadProducts();
                loadOrders(); // Loads orders + updates chart
            }
        });

        // --- 1. PRODUCT LOGIC (With Quantity) ---
        async function loadProducts() {
    const tbody = document.getElementById('productTableBody');
    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Loading...</td></tr>";
    
    try {
        const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        document.getElementById('stat-inventory').innerText = snapshot.size;

        if(snapshot.empty) { tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>No products found.</td></tr>"; return; }

        tbody.innerHTML = "";
        productCostMap = {}; // Reset map

        snapshot.forEach(doc => {
            const item = doc.data();
            const qty = item.quantity || 0;
            const statusClass = qty > 0 ? 'status-available' : 'status-soldout';
            const statusText = qty > 0 ? 'Available' : 'Sold Out';
            const imgUrl = (item.images && item.images[0]) ? item.images[0] : (item.image || 'https://via.placeholder.com/50');
            
            // Store cost for profit calculation (Default to 0 if not set)
            productCostMap[doc.id] = parseFloat(item.buyingCost || 0);

            // Escape name for JS string
            const safeName = item.name.replace(/'/g, "\\'");
            const displayPrice = (item.sellingPrice || item.price) ? `RM ${item.sellingPrice || item.price}` : 'RM 0';

            // Add row to table
            tbody.innerHTML += `
               <tr>
        <td data-label="Image"><img src="${imgUrl}" class="thumb"></td>
        <td data-label="Name" style="font-weight:600;">${item.name}</td>
        <td data-label="Price" style="color:var(--accent); font-weight:600;">${displayPrice}</td>
        <td data-label="Stock">
            <span style="font-weight:700; color:${qty < 5 ? 'red' : 'inherit'}">${qty}</span>
        </td>
        <td data-label="Status"><span class="status-badge ${statusClass}">${statusText}</span></td>
        <td data-label="Actions">
            <div style="display:flex; gap:10px;">
                <button class="action-btn btn-edit" onclick="window.prepareEdit('${doc.id}', '${safeName}', '${item.sellingPrice || item.price}', '${qty}', '${item.buyingCost || 0}')">
                    <i class="fas fa-pen"></i>
                </button>
                <button class="action-btn btn-delete" onclick="window.askDelete('${doc.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    </tr>
`;
        });
        
        // After loading products, reload orders to update profit stats based on new costs
        loadOrders(); 

    } catch (err) { console.error(err); }
}

        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    const files = document.getElementById('pFile').files;
    
    if(files.length === 0) return window.showToast("Image required", "error");
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

    try {
        const uploadPromises = Array.from(files).map(async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_PRESET);
            const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
            return res.json();
        });
        const results = await Promise.all(uploadPromises);
        const imageUrls = results.map(r => r.secure_url);

        await addDoc(collection(db, "products"), {
            name: document.getElementById('pName').value,
            buyingCost: parseFloat(document.getElementById('pBuyCost').value), // NEW
            sellingPrice: parseFloat(document.getElementById('pSellPrice').value), // NEW
            price: document.getElementById('pSellPrice').value, // Keep 'price' for backward compatibility
            category: document.getElementById('pCategory').value,
            quantity: parseInt(document.getElementById('pQty').value),
            status: 'Available',
            description: document.getElementById('pDesc').value,
            images: imageUrls,
            image: imageUrls[0], 
            createdAt: serverTimestamp()
        });

        window.showToast("Product Created!");
        document.getElementById('addProductForm').reset();
        window.updateFileCount(document.getElementById('pFile'));
        loadProducts();
        window.switchProductView('list');

    } catch(e) { window.showToast("Error: "+e.message, "error"); }
    btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> Save Product';
});

        window.updateFileCount = (input) => {
            const label = document.getElementById('uploadText');
            if (input.files && input.files.length > 0) label.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i> ${input.files.length} Selected`;
            else label.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> Click to upload`;
        };

        // --- 2. ORDER LOGIC (Accordion + Filtering) ---
        async function loadOrders() {
    try {
        const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        allOrdersData = []; // Clear Cache
        
        const lists = { pending: [], confirmed: [], shipped: [], delivered: [], all: [] };
        let totalProfit = 0;
        
        // Loop through orders ONCE to calculate data
       snapshot.forEach(doc => {
    const d = doc.data();
    d.id = doc.id; 
    d.dateObj = d.createdAt ? d.createdAt.toDate() : new Date();
    d.dateStr = d.dateObj.toLocaleDateString();
    allOrdersData.push(d);
    
    // Calculate profit accumulation
    totalProfit += calculateOrderProfit(d);

    const firstItem = (d.items && d.items[0]) ? d.items[0] : {name:'?', qty:1};
    const safeOrder = encodeURIComponent(JSON.stringify(d));

    // FORMATTING CURRENCY HERE
    // Use totalAmount if number, otherwise fallback to displayTotal or 0
    let rawTotal = d.totalAmount || 0;
    // If it's a legacy string like "RM 50", strip it to be safe, but usually it's a number now
    if (typeof rawTotal === 'string') rawTotal = parseFloat(rawTotal.replace(/[^\d.-]/g, ''));
    const formattedTotal = "RM " + rawTotal.toLocaleString('en-MY', {minimumFractionDigits: 0, maximumFractionDigits: 2});

    // Status Dropdown
    const makeSelect = (currentStatus) => `
        <select onchange="window.askStatusUpdate('${d.id}', '${currentStatus}', this.value)" style="padding:5px; font-size:12px;">
            <option value="Pending" ${currentStatus=='Pending'?'selected':''}>Pending</option>
            <option value="Confirmed" ${currentStatus=='Confirmed'?'selected':''}>Confirm</option>
            <option value="Shipped" ${currentStatus=='Shipped'?'selected':''}>Shipped</option>
            <option value="Delivered" ${currentStatus=='Delivered'?'selected':''}>Delivered</option>
            <option value="Cancelled" ${currentStatus=='Cancelled'?'selected':''}>Cancelled</option>
        </select>
    `;

    const row = `
        <tr>
            <td data-label="Date">${d.dateStr}</td>
            <td data-label="Customer"><b>${d.customer.name}</b><br><small>${d.customer.phone}</small></td>
            <td data-label="Items">${firstItem.name} <span style="background:#f1f5f9; padding:2px;">x${firstItem.qty||1}</span></td>
            <td data-label="Action">
                <div style="display:flex; gap:5px; align-items:center;">
                    ${makeSelect(d.status)}
                    <button class="action-btn" onclick="window.viewOrder('${safeOrder}')"><i class="fas fa-eye"></i></button>
                </div>
            </td>
        </tr>
    `;

    // Categorize
    if(d.status === 'Pending') lists.pending.push(row);
    if(d.status === 'Confirmed') lists.confirmed.push(row);
    if(d.status === 'Shipped') lists.shipped.push(row);
    if(d.status === 'Delivered') lists.delivered.push(row);
    
    // All Orders Row with RM
    lists.all.push(`
        <tr>
            <td data-label="Date">${d.dateStr}</td>
            <td data-label="Status"><span class="status-badge" style="background:#f1f5f9;">${d.status}</span></td>
            <td data-label="Customer">${d.customer.name}</td>
            <td data-label="Total" style="font-weight:600;">${formattedTotal}</td>
        </tr>
    `);
});
        // --- UPDATE UI OUTSIDE THE LOOP ---
        document.getElementById('tbody-pending').innerHTML = lists.pending.length ? lists.pending.join('') : '<tr><td colspan="4" style="text-align:center; padding:15px;">No pending orders</td></tr>';
        document.getElementById('tbody-confirmed').innerHTML = lists.confirmed.length ? lists.confirmed.join('') : '<tr><td colspan="4" style="text-align:center; padding:15px;">No confirmed orders</td></tr>';
        document.getElementById('tbody-shipped').innerHTML = lists.shipped.join('');
        document.getElementById('tbody-delivered').innerHTML = lists.delivered.join('');
        document.getElementById('tbody-all').innerHTML = lists.all.join('');

        // Update Counts & Profit
        document.getElementById('count-pending').innerText = lists.pending.length;
        document.getElementById('stat-pending').innerText = lists.pending.length;
        document.getElementById('stat-total').innerText = snapshot.size;
        
        // Set final profit text
        document.getElementById('stat-profit').innerText = "RM " + totalProfit.toLocaleString('en-MY');

        // Render Initial Charts (Default 7 Days)
        window.renderSalesChart(7); 
        window.renderProfitChart(7);

    } catch (err) { console.error("Order Load Error", err); }
}

        window.toggleAccordion = (id) => {
            const item = document.getElementById(`acc-${id}`);
            const isOpen = item.classList.contains('open');
            // Close all first (optional, kept for cleaner UI)
            document.querySelectorAll('.accordion-item').forEach(el => el.classList.remove('open'));
            if(!isOpen) item.classList.add('open');
        };
        
        // Helper to open specific accordion from Home
        window.openAccordion = (id) => setTimeout(() => window.toggleAccordion(id), 100);

        // --- 3. INVENTORY & STATUS LOGIC (Crucial Update) ---
        window.askStatusUpdate = (orderId, oldStatus, newStatus) => {
            targetId = orderId; 
            targetAction = 'status_change';
            // Store context for logic
            window.statusContext = { old: oldStatus, new: newStatus };
            
            document.getElementById('modalTitle').innerText = "Update Status";
            document.getElementById('modalDesc').innerText = `Change from ${oldStatus} to ${newStatus}? Stock will be adjusted automatically.`;
            document.getElementById('confirmModal').style.display = 'flex';
        };

        async function handleStatusChange() {
            const { old: oldStatus, new: newStatus } = window.statusContext;
            
            // Fetch Order to get Items
            const orderRef = doc(db, "orders", targetId);
            const orderSnap = await getDoc(orderRef);
            if(!orderSnap.exists()) return;
            const orderData = orderSnap.data();
            const items = orderData.items || [];

            // 1. Determine Inventory Action
            // Action: 'decrease' (Pending -> Confirmed)
            // Action: 'increase' (Confirmed -> Cancelled or Pending)
            let inventoryAction = null;

            const isStockHolding = (s) => ['Confirmed', 'Shipped', 'Delivered'].includes(s);
            const isNonStock = (s) => ['Pending', 'Cancelled'].includes(s);

            if (isNonStock(oldStatus) && isStockHolding(newStatus)) {
                inventoryAction = 'decrease';
            } else if (isStockHolding(oldStatus) && isNonStock(newStatus)) {
                inventoryAction = 'increase';
            }

            // 2. Update Inventory per Item
            if (inventoryAction) {
                for (const item of items) {
                    if (!item.productId) continue;
                    const prodRef = doc(db, "products", item.productId);
                    const prodSnap = await getDoc(prodRef);
                    
                    if (prodSnap.exists()) {
                        let currentQty = prodSnap.data().quantity || 0;
                        let change = parseInt(item.qty || 1);
                        
                        let newQty = inventoryAction === 'decrease' 
                            ? currentQty - change 
                            : currentQty + change;
                        
                        // Prevent negative
                        if (newQty < 0) newQty = 0;

                        // Auto Sold Out Status
                        let prodStatus = newQty === 0 ? 'Sold Out' : 'Available';

                        await updateDoc(prodRef, { quantity: newQty, status: prodStatus });
                    }
                }
            }

            // 3. Update Order Status
            await updateDoc(orderRef, { status: newStatus });
        }

        // --- 4. CONFIRMATION HANDLER ---
        document.getElementById('modalConfirmBtn').addEventListener('click', async () => {
            const btn = document.getElementById('modalConfirmBtn');
            btn.disabled = true; btn.innerText = "Processing...";
            
            try {
                if(targetAction === 'delete') {
                    await deleteDoc(doc(db, "products", targetId));
                    window.showToast("Product deleted");
                    loadProducts();
                }
                if(targetAction === 'status_change') {
                    await handleStatusChange();
                    window.showToast("Status & Inventory Updated");
                    loadOrders();
                    loadProducts(); // Refresh stock numbers
                }
                if(targetAction === 'save_edit') {
                     // Handled separately below, but could be merged
                }
            } catch(e) { window.showToast("Error: " + e.message, "error"); }
            
            window.closeModal();
            btn.disabled = false; btn.innerText = "Proceed";
        });

        // --- 5. EDIT PRODUCT ---
        window.prepareEdit = (id, name, price, qty, cost) => {
    document.getElementById('editId').value = id;
    document.getElementById('editName').value = name;
    document.getElementById('editPrice').value = price;
    document.getElementById('editQty').value = qty;
    document.getElementById('editBuyCost').value = cost; // Populate new field
    document.getElementById('editModal').style.display = 'flex';
};
        
        window.closeEditModal = () => document.getElementById('editModal').style.display = 'none';

        document.getElementById('saveEditBtn').addEventListener('click', async () => {
    const id = document.getElementById('editId').value;
    const inputQty = parseInt(document.getElementById('editQty').value);
    const status = document.getElementById('editStatus').value;
    
    const finalQty = status === 'Sold Out' ? 0 : inputQty;
    const finalStatus = finalQty === 0 ? 'Sold Out' : 'Available';

    await updateDoc(doc(db, "products", id), {
        name: document.getElementById('editName').value,
        sellingPrice: parseFloat(document.getElementById('editPrice').value),
        price: parseFloat(document.getElementById('editPrice').value),
        buyingCost: parseFloat(document.getElementById('editBuyCost').value), // SAVE NEW COST
        quantity: finalQty,
        status: finalStatus
    });
    
    window.showToast("Updated!");
    window.closeEditModal();
    loadProducts();
});
        // --- CHART LOGIC ---

// Helper: Calculate Profit for an Order
const calculateOrderProfit = (order) => {
    if(order.status === 'Cancelled' || order.status === 'Pending') return 0; // Only count profit for confirmed/sold
    
    let totalProfit = 0;
    if(order.items && Array.isArray(order.items)) {
        order.items.forEach(item => {
            const buyCost = productCostMap[item.productId] || 0; // Get Cost from Map
            const sellPrice = parseFloat(item.price || 0); // Price sold at
            const qty = item.qty || 1;
            
            // Profit = (Selling - Buying) * Qty
            totalProfit += (sellPrice - buyCost) * qty;
        });
    }
    return totalProfit;
};

// Update existing loadOrders to calculate total stat
const originalLoadOrders = loadOrders; // Reference existing if needed, but easier to just Paste this snippet inside loadOrders loop

// NOTE: Please ensure you calculate the Total Profit Stat inside your loadOrders function like this:
// let grandTotalProfit = 0;
// ... inside loop ...
// grandTotalProfit += calculateOrderProfit(d);
// ... after loop ...
// document.getElementById('stat-profit').innerText = grandTotalProfit.toLocaleString();


window.updateChart = (type, days, btn) => {
    // Handle UI buttons
    const parent = btn.parentElement;
    parent.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    if(type === 'sales') window.renderSalesChart(days);
    if(type === 'profit') window.renderProfitChart(days);
};

window.renderSalesChart = (days) => {
    const ctx = document.getElementById('salesChart').getContext('2d');
    const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - days);
    const filtered = allOrdersData.filter(o => o.dateObj >= cutoff);
    
    const labels = [];
    const dataOrders = {}; const dataCancel = {};

    for(let i=0; i<days; i++) {
        const d = new Date(); d.setDate(d.getDate() - i);
        const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        labels.unshift(dateStr); 
        dataOrders[dateStr] = 0; dataCancel[dateStr] = 0;
    }

    filtered.forEach(o => {
        const dStr = o.dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        if (dataOrders.hasOwnProperty(dStr)) {
            if(o.status === 'Cancelled') dataCancel[dStr]++;
            else dataOrders[dStr]++;
        }
    });

    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'Completed Orders', data: Object.values(dataOrders), borderColor: '#3b82f6', tension: 0.4 },
                { label: 'Cancelled', data: Object.values(dataCancel), borderColor: '#ef4444', tension: 0.4 }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
};

window.renderProfitChart = (days) => {
    const ctx = document.getElementById('profitChart').getContext('2d');
    const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - days);
    
    // Labels setup
    const labels = [];
    const dataProfit = {};

    // Logic for Day grouping vs Month grouping can be added here, 
    // but for simplicity we will stick to Day-by-Day or Month buckets if days > 30
    
    if(days <= 30) {
        for(let i=0; i<days; i++) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            labels.unshift(dateStr);
            dataProfit[dateStr] = 0;
        }
    } else {
        // Simple Month bucket for 1 Year
        for(let i=0; i<12; i++) {
            const d = new Date(); d.setMonth(d.getMonth() - i);
            const dateStr = d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            labels.unshift(dateStr);
            dataProfit[dateStr] = 0;
        }
    }

    allOrdersData.forEach(o => {
        if(o.dateObj >= cutoff) {
            let dStr;
            if(days <= 30) dStr = o.dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            else dStr = o.dateObj.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });

            if (dataProfit.hasOwnProperty(dStr)) {
                dataProfit[dStr] += calculateOrderProfit(o);
            }
        }
    });

    if(profitChartInstance) profitChartInstance.destroy();
    profitChartInstance = new Chart(ctx, {
        type: 'bar', // Bar chart often looks better for profit volumes
        data: {
            labels: labels,
            datasets: [
                { 
                    label: 'Net Profit', 
                    data: Object.values(dataProfit), 
                    backgroundColor: '#10b981', 
                    borderRadius: 4 
                }
            ]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });
};

// Initial Render calls (Add inside loadOrders or Auth success)
// Note: Call window.renderChart('sales', 7, document.querySelector('.filter-btn.active'))
// and window.renderChart('profit', 7, ...);

        // --- 7. MODAL UTILS ---
        window.closeModal = () => document.getElementById('confirmModal').style.display = 'none';
        window.askDelete = (id) => {
            targetId = id; targetAction = 'delete';
            document.getElementById('modalTitle').innerText = "Delete Product?";
            document.getElementById('modalDesc').innerText = "Irreversible action.";
            document.getElementById('confirmModal').style.display = 'flex';
        };

        window.viewOrder = (json) => {
    const d = JSON.parse(decodeURIComponent(json));
    
    // Format Items with RM
    const itemsHtml = d.items.map(i => {
        const p = parseFloat(i.price || 0);
        const subtotal = p * (i.qty || 1);
        return `
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:8px 0;">
            <span>${i.name} <small>x${i.qty||1}</small></span>
            <span>RM ${subtotal.toLocaleString()}</span>
        </div>`;
    }).join('');

    // Format Total with RM
    let rawTotal = d.totalAmount || 0;
    if (typeof rawTotal === 'string') rawTotal = parseFloat(rawTotal.replace(/[^\d.-]/g, ''));
    const formattedTotal = "RM " + rawTotal.toLocaleString('en-MY');

    document.getElementById('orderModalContent').innerHTML = `
        <div style="background:#f8fafc; padding:15px; border-radius:8px; font-size:14px; margin-bottom:15px;">
            <div><b>Order ID:</b> #${d.id.slice(-6).toUpperCase()}</div>
            <div><b>Date:</b> ${new Date(d.createdAt.seconds*1000).toLocaleString()}</div>
            <div><b>Status:</b> ${d.status}</div>
            <hr style="border:0; border-top:1px dashed #cbd5e1; margin:10px 0;">
            <b>${d.customer.name}</b><br>${d.customer.phone}<br>${d.customer.address}
        </div>
        <h4>Items</h4>
        ${itemsHtml}
        <div style="display:flex; justify-content:space-between; margin-top:15px; font-weight:700; font-size:16px;">
            <span>TOTAL</span><span style="color:var(--primary);">${formattedTotal}</span>
        </div>
    `;
    document.getElementById('orderModal').style.display = 'flex';
};
        window.closeOrderModal = () => document.getElementById('orderModal').style.display = 'none';

    </script>
</body>
</html>
